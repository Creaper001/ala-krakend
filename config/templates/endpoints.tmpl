{{ define "endpoints" }}
  {{ $domains := . }}
  {{ range $domain, $routes := $domains }}
    {{ range $idx, $route := $routes }}
      {{ if $idx }},{{ end }}
      {
        "endpoint": "{{ $domain }}/{{ $route.endpoint }}",
        "method": "{{ $route.method }}",
        "encondig": "json",
        "backend": [
          {
            "url_pattern": "{{ $domain }}/{{ $route.backend.url_pattern }}",
            "method": "{{ $route.backend.method }}",
            "extra_config": {
              "backend/http": {
                "return_error_code": true
              },
              "modifier/martian": {
                "header.Modifier": {
                  "scope": ["request"],
                  "name": "Context",
                  "value": "{{ env "BACKEND_CONTEXT" }}"
                }
              }
            }
          }
        ]
      }
    {{ end }}
  {{ end }}
{{ end }}